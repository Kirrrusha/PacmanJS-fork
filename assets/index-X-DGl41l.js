(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=e(s);fetch(s.href,a)}})();var $=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},p={},q={},U={};Object.defineProperty(U,"__esModule",{value:!0});var jt=function(){function n(t,e,i,s,a,r){s===void 0&&(s=1),a===void 0&&(a=s),r===void 0&&(r=1),this.gtpImage=t,this.cellW=e,this.cellH=i,this.spacingX=s,this.spacingY=a,r!==1&&(this.cellW*=r,this.cellH*=r,this.spacingX*=r,this.spacingY*=r),this.rowCount=Math.floor(t.height/(this.cellH+this.spacingY)),t.height-this.rowCount*(this.cellH+this.spacingY)>=this.cellH&&this.rowCount++,this.colCount=Math.floor(t.width/(this.cellW+this.spacingX)),t.width-this.colCount*(this.cellW+this.spacingX)>=this.cellW&&this.colCount++,this.size=this.rowCount*this.colCount}return n.prototype.drawSprite=function(t,e,i,s,a){var r=this.cellW,o=this.cellH,h=(r+this.spacingX)*a,l=(o+this.spacingY)*s;this.gtpImage.drawScaled2(t,h,l,r,o,e,i,r,o)},n.prototype.drawByIndex=function(t,e,i,s){var a=Math.floor(s/this.colCount),r=Math.floor(s%this.colCount);this.drawSprite(t,e,i,a,r)},n}();U.default=jt;var mt={};(function(n){Object.defineProperty(n,"__esModule",{value:!0}),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.IMAGE=1]="IMAGE",t[t.AUDIO=2]="AUDIO",t[t.JSON=3]="JSON"}(n.AssetType||(n.AssetType={}))})(mt);var C={},J={};Object.defineProperty(J,"__esModule",{value:!0});J.default={getWindowLocationSearch:function(){return window.location.search}};Object.defineProperty(C,"__esModule",{value:!0});var Xt=J;C.default={getObjectSize:function(n){var t=0;for(var e in n)n.hasOwnProperty(e)&&t++;return t},getRequestParam:function(n){var t="&"+Xt.default.getWindowLocationSearch().substring(1),e="&"+n,i=t.indexOf(e);if(i>=-1){var s=i+e.length;if(t.charAt(s)==="="){s++;var a=t.indexOf("&",s);return a===-1&&(a=t.length),t.substring(s,a)}if(t.charAt(s)==="&"||s===t.length)return""}return null},hitch:function(n,t){return function(){t.apply(n,arguments)}},mixin:function(n,t){for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e])},randomInt:function(n,t){var e,i;return typeof t>"u"?(e=0,i=n):(e=n,i=t),Math.floor(Math.random()*(i-e))+e},timestamp:function(){return window.performance&&window.performance.now?window.performance.now():Date.now()},initConsole:function(){if(!window.console){var n=function(){};window.console={info:n,log:n,warn:n,error:n}}}};var P={};Object.defineProperty(P,"__esModule",{value:!0});var j=256,Zt=function(){function n(){}return n.resize=function(t,e){e===void 0&&(e=1);var i,s;if(t instanceof HTMLImageElement?(i=n.createCanvas(t.width,t.height),s=i.getContext("2d"),s.drawImage(t,0,0)):(i=t,s=i.getContext("2d")),e===1)return i;for(var a=s.getImageData(0,0,t.width,t.height),r=t.width*e,o=t.height*e,h=n.createCanvas(r,o),l=h.getContext("2d"),c=l.getImageData(0,0,r,o),d=0;d<o;d++)for(var S=0;S<r;S++){var T=(Math.floor(d/e)*t.width+Math.floor(S/e))*4,E=(d*r+S)*4;c.data[E]=a.data[T],c.data[E+1]=a.data[T+1],c.data[E+2]=a.data[T+2],c.data[E+3]=a.data[T+3]}return l.putImageData(c,0,0),h},n.createCanvas=function(t,e,i){var s=document.createElement("canvas");if(s.width=t,s.height=e,n.prepCanvas(s),i){var a=typeof i=="string"?document.getElementById(i):i;a.innerHTML="",a.appendChild(s)}return s},n.ensure256Square=function(t){if(t.width<j||t.height<j){var e=Math.max(j,t.width),i=Math.max(j,t.height),s=n.createCanvas(e,i),a=s.getContext("2d");a.drawImage(t,0,0),t=s}return t},n.prepCanvas=function(t){var e=t.getContext("2d");e.imageSmoothingEnabled=!1,e.mozImageSmoothingEnabled=!1,e.oImageSmoothingEnabled=!1,e.webkitImageSmoothingEnabled=!1,e.msImageSmoothingEnabled=!1},n.makeColorTranslucent=function(t,e,i){e===void 0&&(e=0),i===void 0&&(i=0);for(var s=t.getContext("2d"),a=t.width,r=t.height,o=s.getImageData(0,0,a,r),h=[],l=(i*a+e)*4,c=0;c<4;c++)h[c]=o.data[l+c];for(i=0;i<r;i++)for(e=0;e<a;e++){var d=(i*a+e)*4;o.data[d]===h[0]&&o.data[d+1]===h[1]&&o.data[d+2]===h[2]&&o.data[d+3]===h[3]&&(o.data[d]=0,o.data[d+1]=0,o.data[d+2]=0,o.data[d+3]=0)}return s.putImageData(o,0,0),t},n.allowSubpixelImageRendering=!1,n}();P.default=Zt;var W={};Object.defineProperty(W,"__esModule",{value:!0});var G=P,$t=function(){function n(t,e,i,s,a){e!==void 0&&i!==void 0&&s!==void 0&&a!==void 0?(this.x=e,this.y=i,this.w=s,this.h=a):(this.x=this.y=0,this.w=t.width,this.h=t.height),this.canvas=G.default.ensure256Square(t)}return n.prototype.draw=function(t,e,i){G.default.allowSubpixelImageRendering||(e=Math.round(e),i=Math.round(i)),t.drawImage(this.canvas,this.x,this.y,this.w,this.h,e,i,this.w,this.h)},n.prototype.drawScaled=function(t,e,i,s,a){G.default.allowSubpixelImageRendering||(e=Math.round(e),i=Math.round(i)),t.drawImage(this.canvas,this.x,this.y,this.w,this.h,e,i,s,a)},n.prototype.drawScaled2=function(t,e,i,s,a,r,o,h,l){G.default.allowSubpixelImageRendering||(e=Math.round(e),i=Math.round(i),r=Math.round(r),o=Math.round(o)),e=this.x+e,i=this.y+i,t.drawImage(this.canvas,e,i,s,a,r,o,h,l)},n.prototype.makeColorTranslucent=function(t,e){t===void 0&&(t=0),e===void 0&&(e=0),G.default.makeColorTranslucent(this.canvas,t,e)},Object.defineProperty(n.prototype,"width",{get:function(){return this.w},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"height",{get:function(){return this.h},enumerable:!0,configurable:!0}),n}();W.default=$t;var Q={};Object.defineProperty(Q,"__esModule",{value:!0});var Vt=function(){function n(t,e,i){i===void 0&&(i=0),this.id=t,this.buffer=e,this.loopsByDefault=!0,this.loopStart=i}return n.prototype.getBuffer=function(){return this.buffer},n.prototype.getId=function(){return this.id},n.prototype.getLoopsByDefaultIfMusic=function(){return this.loopsByDefault},n.prototype.setLoopsByDefaultIfMusic=function(t){this.loopsByDefault=t},n.prototype.getLoopStart=function(){return this.loopStart},n.prototype.setLoopStart=function(t){this.loopStart=t},n}();Q.default=Vt;var z={};Object.defineProperty(z,"__esModule",{value:!0});var qt=W,Jt=P,Qt=function(){function n(t,e){this.atlasInfo=e,this.masterCanvas=t,this.atlasInfo.firstPixelIsTranslucent&&(this.masterCanvas=Jt.default.makeColorTranslucent(this.masterCanvas))}return n.prototype.parse=function(t){var e=this;t===void 0&&(t=1);var i={};return this.atlasInfo.images.forEach(function(s){var a=s.id,r,o,h,l;if(s.dim){var c=s.dim.split(/,\s*/);if(c.length!==4)throw new Error("Invalid value for imgInfo "+a+"'s dim: "+s.dim);r=parseInt(c[0],10),o=parseInt(c[1],10),h=parseInt(c[2],10),l=parseInt(c[3],10)}else if(r=typeof s.x=="number"?s.x:-1,o=typeof s.y=="number"?s.y:-1,typeof s.s=="number"?h=l=s.s:(h=typeof s.w=="number"?s.w:-1,l=typeof s.h=="number"?s.h:-1),r<0||o<0||h<0||l<0)throw new Error("x, y, w, h (or s) not specified for imgInfo: "+JSON.stringify(s));t!==1&&(r*=t,o*=t,h*=t,l*=t),i[a]=new qt.default(e.masterCanvas,r,o,h,l)}),i},n}();z.default=Qt;Object.defineProperty(q,"__esModule",{value:!0});var zt=U,w=mt,b=C,X=P,Rt=W,te=Q,ee=z,ie=function(){function n(t,e,i){t===void 0&&(t=1),this.scale=t||1,this.loadingAssetData={},this.responses={},this.callback=null,this.audio=e,this.assetRoot=i}return n.prototype.addJson=function(t,e){var i=this;if(e===void 0&&(e=t),this.assetRoot&&(e=this.assetRoot+e),!this._isAlreadyTracked(t)){this.loadingAssetData[t]={type:w.AssetType.JSON},console.log("Adding: "+t+" => "+e+", remaining == "+b.default.getObjectSize(this.loadingAssetData)+", callback == "+(this.callback!==null));var s=new XMLHttpRequest;s.onreadystatechange=function(){if(s.readyState===XMLHttpRequest.DONE){var a=s.responseText;i._completed(t,a)}},s.open("GET",e,!0),s.send(null)}},n.prototype.addCanvas=function(t,e){var i=this;this.assetRoot&&(e=this.assetRoot+e);var s=document.createElement("img");this._isAlreadyTracked(t)||(this.loadingAssetData[t]={type:w.AssetType.IMAGE},console.log("Adding: "+t+" => "+e+", remaining == "+b.default.getObjectSize(this.loadingAssetData)+", callback == "+(this.callback!==null)),s.addEventListener("load",function(){var a=X.default.resize(s,i.scale);i._completed(t,a)}),s.src=e)},n.prototype.addImage=function(t,e,i){var s=this;i===void 0&&(i=!1),this.assetRoot&&(e=this.assetRoot+e);var a=document.createElement("img");this._isAlreadyTracked(t)||(this.loadingAssetData[t]={type:w.AssetType.IMAGE},console.log("Adding: "+t+" => "+e+", remaining == "+b.default.getObjectSize(this.loadingAssetData)+", callback == "+(this.callback!==null)),a.addEventListener("load",function(){var r=X.default.resize(a,s.scale),o=new Rt.default(r);i&&o.makeColorTranslucent(0,0),s._completed(t,o)}),a.src=e)},n.prototype.addImageAtlasContents=function(t,e,i){var s=this;this.assetRoot&&(e=this.assetRoot+e);var a=document.createElement("img");this._isAlreadyTracked(t)||(this.loadingAssetData[t]={type:w.AssetType.IMAGE},console.log("Adding: "+t+" => "+e+", remaining == "+b.default.getObjectSize(this.loadingAssetData)+", "+("callback == "+(this.callback!==null))),a.addEventListener("load",function(){var r=X.default.resize(a,s.scale),o=new ee.default(r,i),h=typeof i.prefix=="string"?i.prefix:i.prefix?t+".":"",l=o.parse();for(var c in l)l.hasOwnProperty(c)&&(s.responses[h+c]=l[c]);s._completed(t,o)}),a.src=e)},n.prototype.addSound=function(t,e,i,s){var a=this;if(i===void 0&&(i=0),s===void 0&&(s=!0),this.audio.isInitialized()){if(this._isAlreadyTracked(t))return;this.loadingAssetData[t]={type:w.AssetType.AUDIO},this.assetRoot&&(e=this.assetRoot+e);var r=new XMLHttpRequest;r.onload=function(){a.audio.context.decodeAudioData(r.response,function(o){var h=new te.default(t,o,i||0);h.setLoopsByDefaultIfMusic(s),a.audio.addSound(h),a._completed(t,o)})},r.open("GET",e,!0),r.responseType="arraybuffer",r.send(null)}},n.prototype.addSpriteSheet=function(t,e,i,s,a,r,o){var h=this;a===void 0&&(a=0),r===void 0&&(r=0),o===void 0&&(o=!1),a=a||0,r=r||0,i*=this.scale,s*=this.scale,a*=this.scale,r*=this.scale,this.assetRoot&&(e=this.assetRoot+e);var l=document.createElement("img");this._isAlreadyTracked(t)||(this.loadingAssetData[t]={type:w.AssetType.IMAGE},console.log("Adding: "+t+" => "+e+", remaining == "+b.default.getObjectSize(this.loadingAssetData)+", callback == "+(this.callback!==null)),l.addEventListener("load",function(){var c=X.default.resize(l,h.scale),d=new Rt.default(c);o&&d.makeColorTranslucent(0,0);var S=new zt.default(d,i,s,a,r);h._completed(t,S)}),l.src=e)},n.prototype.addTmxMap=function(t){if(t.tilesets&&t.tilesets.length)for(var e=0;e<t.tilesets.length;e++){var i=t.tilesets[e],s="_tilesetImage_"+i.name;this.addImage(s,i.image)}},n.prototype.getTmxTilesetImage=function(t){return this.responses["_tilesetImage_"+t.name]},n.prototype.get=function(t){return this.responses[t]},n.prototype._isAlreadyTracked=function(t){return this.loadingAssetData[t]?(console.log("A resource with id "+t+" is already loading.  Assuming they are the same"),!0):this.responses[t]?(console.log("A resource with id "+t+" has already been loaded."),!0):!1},n.prototype.set=function(t,e){this.responses[t]=e},n.prototype._completed=function(t,e){if(!this.loadingAssetData[t]){console.error("Resource not found! - "+t);return}this.loadingAssetData[t].type===w.AssetType.JSON&&(e=JSON.parse(e)),this.responses[t]=e,delete this.loadingAssetData[t],console.log("Completed: "+t+", remaining == "+b.default.getObjectSize(this.loadingAssetData)+", callback == "+(this.callback!==null)),this.isDoneLoading()&&this.callback?(this.callback.call(this),delete this.callback,console.log("... Callback called and deleted (callback == "+(this.callback!==null)+")"),this.nextCallback&&(this.callback=this.nextCallback,delete this.nextCallback)):console.log("... Not running callback - "+this.isDoneLoading()+", "+(this.callback!==null))},n.prototype.isDoneLoading=function(){return b.default.getObjectSize(this.loadingAssetData)===0},n.prototype.onLoad=function(t){this.isDoneLoading()?t():this.callback?this.nextCallback=t:this.callback=t},n}();q.default=ie;var tt={};Object.defineProperty(tt,"__esModule",{value:!0});var se=function(){function n(t){this.config=t,this.id=-1,this.soundId=void 0,this.source=void 0,this.paused=!1,this.startOffset=-1,this.startTime=-1,this.playedTime=0}return n.prototype.initFromConfig=function(){var t=this;if(this.id=this.config.id,this.soundId=this.config.soundId,this.source=this.config.audioSystem.context.createBufferSource(),this.source.loop=this.config.loop,this.source.buffer=this.config.buffer,this.config.connectTo instanceof AudioNode)this.source.connect(this.config.connectTo);else{var e=this.config.connectTo;e.forEach(function(i){t.source.connect(i)})}this.startOffset=this.config.startOffset||0,this.config.loop||(this.source.onended=this.config.onendedGenerator(this.id))},n.prototype.isPaused=function(){return this.paused},n.prototype.pause=function(){this.paused||(this.source.stop(),this.playedTime+=this.source.context.currentTime-this.startTime,this.paused=!0,this.startTime=0)},n.prototype.resume=function(){if(this.paused){this.paused=!1;var t=this.startOffset;this.initFromConfig(),this.startOffset=t+this.playedTime,this.startOffset=this.startOffset%this.source.buffer.duration;var e=this.source.context.currentTime;this.source.start(e,this.startOffset),this.startTime=e,this.playedTime=0}},n.prototype.start=function(){this.paused=!1,this.initFromConfig();var t=this.source.context.currentTime;this.source.start(t,this.startOffset),this.startTime=t,this.playedTime=0},n}(),ne=.3,re=1e3,ae=function(){function n(){this.currentMusic=null,this.sounds={},this.musicFade=ne,this.doFadeMusic=!0,this.muted=!1,this.initialized=!1,this.playingSounds=[],this.soundEffectIdGenerator=0}return n.prototype.createPlayingSound=function(t,e,i,s){var a=this;e===void 0&&(e=!1),i===void 0&&(i=0);var r=this.createSoundEffectId();return new se({audioSystem:this,buffer:this.sounds[t].getBuffer(),connectTo:this.volumeFaderGain,id:r,loop:e,onendedGenerator:function(o){return function(){a.removePlayingSound(o),s&&s(r,t)}},soundId:t,startOffset:i})},n.prototype.createSoundEffectId=function(){return this.soundEffectIdGenerator++},n.prototype.init=function(){var t=window;try{t.AudioContext=t.AudioContext||t.webkitAudioContext,t.AudioContext?(this.context=new t.AudioContext,this.volumeFaderGain=this.context.createGain(),this.volumeFaderGain.gain.setValueAtTime(1,this.context.currentTime),this.volumeFaderGain.gain.value=1,this.volumeFaderGain.connect(this.context.destination),this.initialized=!0):console.log("The Web Audio API is not supported in this browser.")}catch{console.error("The Web Audio API is not supported in this browser.")}},n.prototype.addSound=function(t){this.context&&(this.sounds[t.getId()]=t)},n.prototype.fadeOutMusic=function(t){var e=this;this.context&&(this.currentMusic?(this.muted||(this.musicFaderGain.gain.setValueAtTime(this.musicFaderGain.gain.value,this.context.currentTime),this.musicFaderGain.gain.linearRampToValueAtTime(0,this.context.currentTime+this.musicFade)),setTimeout(function(){e.playMusic(t)},this.musicFade*re)):this.playMusic(t))},n.prototype.getCurrentMusic=function(){return this.currentMusicId},n.prototype.isInitialized=function(){return this.initialized},n.prototype.pauseAll=function(){this.playingSounds.forEach(function(t){t.pause()})},n.prototype.playMusic=function(t,e){if(this.context){if(this.currentMusic&&this.stopMusic(!1),!t)return;var i=this.sounds[t];typeof e>"u"&&(e=i.getLoopsByDefaultIfMusic()),this.musicFaderGain=this.context.createGain(),this.musicFaderGain.gain.setValueAtTime(1,this.context.currentTime),this.musicFaderGain.gain.value=1,this.currentMusic=this.context.createBufferSource(),this.currentMusic.loop=e,this.musicLoopStart=i.getLoopStart()||0,this.currentMusic.loopStart=this.musicLoopStart,this.currentMusic.buffer=i.getBuffer(),this.currentMusic.loopEnd=this.currentMusic.buffer.duration,this.currentMusic.connect(this.musicFaderGain),this.musicFaderGain.connect(this.volumeFaderGain),this.currentMusic.start(0),this.currentMusicId=t,console.log("Just started new music with id: "+t+", loop: "+e)}},n.prototype.playSound=function(t,e,i){if(e===void 0&&(e=!1),this.context){var s=this.createPlayingSound(t,e,0,i);return this.playingSounds.push(s),s.start(),s.id}return-1},n.prototype.removePlayingSound=function(t){for(var e=0;e<this.playingSounds.length;e++)if(this.playingSounds[e].id===t){var i=this.playingSounds[e];return this.playingSounds.splice(e,1),i}return null},n.prototype.resumeAll=function(){for(var t=0;t<this.playingSounds.length;t++){var e=this.playingSounds[t];e.isPaused()&&e.resume()}},n.prototype.stopMusic=function(t){t===void 0&&(t=!1),this.currentMusic&&(this.currentMusic.stop(),t||(this.currentMusic.disconnect(),this.musicFaderGain.disconnect(),delete this.currentMusic,delete this.musicFaderGain))},n.prototype.stopSound=function(t){var e=this.removePlayingSound(t);return e&&e.source?(e.source.stop(),!0):!1},n.prototype.toggleMuted=function(){if(this.muted=!this.muted,this.context){var t=this.muted?0:1;this.volumeFaderGain.gain.setValueAtTime(t,this.context.currentTime),this.volumeFaderGain.gain.value=t}return this.muted},Object.defineProperty(n.prototype,"fadeMusic",{get:function(){return this.doFadeMusic},set:function(t){this.doFadeMusic=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"musicFadeSeconds",{get:function(){return this.musicFade},set:function(t){this.musicFade=t},enumerable:!0,configurable:!0}),n}();tt.default=ae;var St={},oe=$&&$.__extends||function(){var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,s){i.__proto__=s}||function(i,s){for(var a in s)s.hasOwnProperty(a)&&(i[a]=s[a])},n(t,e)};return function(t,e){n(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}();Object.defineProperty(St,"__esModule",{value:!0});var he=U,ue=32,le=function(n){oe(t,n);function t(e,i,s,a,r,o){return o===void 0&&(o=1),n.call(this,e,i,s,a,r,o)||this}return t.prototype.drawString=function(e,i,s){for(var a=this.size,r=window,o=r.game.canvas.getContext("2d"),h=this.cellW,l=0;l<e.length;l++){var c=e.charCodeAt(l)-ue;(c<0||c>=a)&&(c=0),this.drawByIndex(o,i,s,c),i+=h}},t}(he.default);St.default=le;var _t={},Tt={};(function(n){Object.defineProperty(n,"__esModule",{value:!0}),function(t){t[t.STRETCH_NONE=0]="STRETCH_NONE",t[t.STRETCH_FILL=1]="STRETCH_FILL",t[t.STRETCH_PROPORTIONAL=2]="STRETCH_PROPORTIONAL"}(n.StretchMode||(n.StretchMode={}))})(Tt);Object.defineProperty(_t,"__esModule",{value:!0});var dt=Tt;_t.default={resize:function(n,t){switch(t){default:case dt.StretchMode.STRETCH_NONE:n.style.width=n.width+"px",n.style.height=n.height+"px";break;case dt.StretchMode.STRETCH_FILL:n.style.width=document.body.clientWidth+"px",n.style.height=document.body.clientHeight+"px";break;case dt.StretchMode.STRETCH_PROPORTIONAL:var e=document.body.clientWidth/(n.width*1),i=document.body.clientHeight/(n.height*1),s=Math.min(e,i);n.style.width=Math.floor(n.width*s)+"px",n.style.height=Math.floor(n.height*s)+"px";break}}};var Et={};Object.defineProperty(Et,"__esModule",{value:!0});var ce=function(){function n(t){if(!t||!t.millis)throw'Missing required "millis" argument to Delay';this.initial=Array.isArray(t.millis)?t.millis:[t.millis],this.initialIndex=0,t.minDelta&&t.maxDelta&&this.setRandomDelta(t.minDelta,t.maxDelta),this.callback=t.callback,this.loop=!!t.loop,this.loopCount=0,this.maxLoopCount=this.loop&&t.loopCount||-1,this.remaining=0,this.curInitial=0,this.reset()}return n.prototype.update=function(t){return this.remaining>0&&(this.remaining-=t,this.remaining<=0&&this.callback&&this.callback(this)),this.remaining<=0&&(this.loop?this.maxLoopCount===-1||this.loopCount<this.maxLoopCount-1?(this.loopCount++,this.reset(!0)):(this.loopCount=this.maxLoopCount,this.remaining=-1):this.remaining=Math.max(0,this.remaining)),this.isDone()},n.prototype.getLoopCount=function(){return this.loopCount},n.prototype.getMaxDelta=function(){return typeof this.maxDelta<"u"?this.maxDelta:-1},n.prototype.getMinDelta=function(){return typeof this.minDelta<"u"?this.minDelta:-1},n.prototype.getRemaining=function(){return this.remaining},n.prototype.getRemainingPercent=function(){return this.remaining/this.curInitial},n.prototype.isDone=function(){return(!this.loop||this.loopCount===this.maxLoopCount)&&this.remaining<=0},n.prototype.setRandomDelta=function(t,e){this.minDelta=t,this.maxDelta=e},n.prototype.reset=function(t){t=!!t;var e=this.remaining;this.curInitial=this.remaining=this.initial[this.initialIndex],t&&e<0&&(this.remaining+=e),this.initialIndex=(this.initialIndex+1)%this.initial.length,this.minDelta||this.maxDelta},n.prototype.toString=function(){return"[Delay: _initial="+this.initial+", "+("_remaining="+this.remaining+", ")+("_loop="+this.loop+", ")+("_callback="+!!this.callback)+"]"},n}();Et.default=ce;var vt={},B={},et={},it={};(function(n){Object.defineProperty(n,"__esModule",{value:!0}),function(t){t[t.KEY_ENTER=13]="KEY_ENTER",t[t.KEY_SHIFT=16]="KEY_SHIFT",t[t.KEY_CTRL=17]="KEY_CTRL",t[t.KEY_SPACE=32]="KEY_SPACE",t[t.KEY_LEFT_ARROW=37]="KEY_LEFT_ARROW",t[t.KEY_UP_ARROW=38]="KEY_UP_ARROW",t[t.KEY_RIGHT_ARROW=39]="KEY_RIGHT_ARROW",t[t.KEY_DOWN_ARROW=40]="KEY_DOWN_ARROW",t[t.KEY_0=48]="KEY_0",t[t.KEY_1=49]="KEY_1",t[t.KEY_2=50]="KEY_2",t[t.KEY_3=51]="KEY_3",t[t.KEY_4=52]="KEY_4",t[t.KEY_5=53]="KEY_5",t[t.KEY_6=54]="KEY_6",t[t.KEY_7=55]="KEY_7",t[t.KEY_8=56]="KEY_8",t[t.KEY_9=57]="KEY_9",t[t.KEY_A=65]="KEY_A",t[t.KEY_B=66]="KEY_B",t[t.KEY_C=67]="KEY_C",t[t.KEY_D=68]="KEY_D",t[t.KEY_E=69]="KEY_E",t[t.KEY_F=70]="KEY_F",t[t.KEY_G=71]="KEY_G",t[t.KEY_H=72]="KEY_H",t[t.KEY_I=73]="KEY_I",t[t.KEY_J=74]="KEY_J",t[t.KEY_K=75]="KEY_K",t[t.KEY_L=76]="KEY_L",t[t.KEY_M=77]="KEY_M",t[t.KEY_N=78]="KEY_N",t[t.KEY_O=79]="KEY_O",t[t.KEY_P=80]="KEY_P",t[t.KEY_Q=81]="KEY_Q",t[t.KEY_R=82]="KEY_R",t[t.KEY_S=83]="KEY_S",t[t.KEY_T=84]="KEY_T",t[t.KEY_U=85]="KEY_U",t[t.KEY_V=86]="KEY_V",t[t.KEY_W=87]="KEY_W",t[t.KEY_X=88]="KEY_X",t[t.KEY_Y=89]="KEY_Y",t[t.KEY_Z=90]="KEY_Z"}(n.Keys||(n.Keys={}))})(it);var st={};Object.defineProperty(st,"__esModule",{value:!0});var O=it,de=function(){function n(t){t===void 0&&(t=0),this.keys=[],this.refireMillis=t,this.repeatTimers=[]}return n.prototype.clearKeyState=function(t){this.keys[t]=!1,this.repeatTimers[t]&&(clearInterval(this.repeatTimers[t]),delete this.repeatTimers[t])},n.prototype.clearKeyStates=function(){for(var t=0;t<this.keys.length;t++)this.clearKeyState(t)},n.prototype.ctrl=function(t){return t===void 0&&(t=!1),this.isKeyDown(O.Keys.KEY_CTRL,t)},n.prototype.down=function(t){return t===void 0&&(t=!1),this.isKeyDown(O.Keys.KEY_DOWN_ARROW,t)},n.prototype.enter=function(t){return t===void 0&&(t=!1),this.isKeyDown(O.Keys.KEY_ENTER,t)},n.prototype.install=function(){var t=this;document.onkeydown=function(e){t._keyDown(e)},document.onkeyup=function(e){t._keyUp(e)}},n.prototype.isKeyDown=function(t,e){e===void 0&&(e=!1);var i=this.keys[t];return i&&e&&(this.keys[t]=!1),i},n.prototype._keyDown=function(t){var e=this,i=t.keyCode;(i===32||i>=37&&i<=40)&&t.preventDefault(),this.refireMillis?this.repeatTimers[i]||(this.keys[i]=!0,this.repeatTimers[i]=setInterval(function(){e.keys[i]=!0},this.refireMillis)):this.keys[i]=!0,t.stopPropagation()},n.prototype._keyUp=function(t){var e=t.keyCode;this.refireMillis?this.repeatTimers[e]?(this.keys[e]=!1,clearInterval(this.repeatTimers[e]),delete this.repeatTimers[e]):console.error("_keyUp: Timer does not exist for key: "+e+"!"):this.keys[e]=!1,t.stopPropagation()},n.prototype.left=function(t){return t===void 0&&(t=!1),this.isKeyDown(O.Keys.KEY_LEFT_ARROW,t)},n.prototype.right=function(t){return t===void 0&&(t=!1),this.isKeyDown(O.Keys.KEY_RIGHT_ARROW,t)},n.prototype.shift=function(t){return t===void 0&&(t=!1),this.isKeyDown(O.Keys.KEY_SHIFT,t)},n.prototype.up=function(t){return t===void 0&&(t=!1),this.isKeyDown(O.Keys.KEY_UP_ARROW,t)},n}();st.default=de;var It={};Object.defineProperty(It,"__esModule",{value:!0});var A=C,fe=function(){function n(){this.isPaused=!1,this.pauseStart=0,this.isUpdating=!0,this.notUpdatingStart=0,this.startShift=0}return Object.defineProperty(n.prototype,"paused",{get:function(){return this.isPaused},set:function(t){if(this.isPaused!==t)if(this.isPaused=t,t)this.pauseStart=A.default.timestamp();else{var e=A.default.timestamp()-this.pauseStart;this.startShift+=e,this.pauseStart=0}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"playTime",{get:function(){return this.pauseStart!==0?this.pauseStart-this.startShift:this.notUpdatingStart!==0?this.notUpdatingStart-this.startShift:A.default.timestamp()-this.startShift},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"updating",{get:function(){return this.isUpdating},set:function(t){if(this.isUpdating!==t&&(this.isUpdating=t,!this.paused))if(!this.isUpdating)this.notUpdatingStart=A.default.timestamp();else{var e=A.default.timestamp()-this.notUpdatingStart;this.startShift+=e,this.notUpdatingStart=0}},enumerable:!0,configurable:!0}),n.prototype.resetPlayTime=function(){if(this.paused||!this.updating)throw"Cannot reset playtime millis when paused or not updating";this.startShift=A.default.timestamp()},n.prototype.start=function(){this.startShift=A.default.timestamp()},n}();It.GameTimer=fe;var nt={};Object.defineProperty(nt,"__esModule",{value:!0});var Mt=C,pe=function(){function n(){this.startTimes={},this.prefix="DEBUG"}return n.prototype.setLogPrefix=function(t){t===void 0&&(t="DEBUG"),this.prefix=t},n.prototype.start=function(t){this.startTimes[t]=Mt.default.timestamp()},n.prototype.end=function(t){var e=this.startTimes[t];if(!e)return console.error('Cannot end timer for "'+t+'" as it was never started'),-1;var i=Mt.default.timestamp()-e;return delete this.startTimes[t],i},n.prototype.endAndLog=function(t){var e=this.end(t);e>-1&&console.log(this.prefix+": "+t+": "+e+" ms")},n}();nt.default=pe;Object.defineProperty(et,"__esModule",{value:!0});var Nt=it,ge=st,me=It,Se=nt,_e=P,Z=C,Te=tt,Ee=q,Dt=100,ve=.1,xt=1e3,Ie=30,ye=function(){function n(t){t===void 0&&(t={width:640,height:480}),Z.default.initConsole(),this.scale=t.scale||1,this.canvas=_e.default.createCanvas(t.width,t.height,t.parent),this.inputManager=new ge.default(t.keyRefreshMillis||0),this.inputManager.install(),this.targetFps=t.targetFps||Ie,this.interval=xt/this.targetFps,this.lastTime=0,this.audio=new Te.default,this.audio.init();var e=t.assetRoot;this.assets=new Ee.default(this.scale,this.audio,e),this.clearScreenColor="rgb(0,0,0)",this.fpsColor="rgb(255,255,255)",this.statusMessageRGB="255,255,255",this.statusMessageColor=null,this.showFps=!1,this.frames=0,this.fpsMsg=this.targetFps+" fps",this.statusMessage=null,this.statusMessageAlpha=0,this.statusMessageTime=0,this.gameTimer=new me.GameTimer,this.timer=new Se.default}return n.prototype.clearScreen=function(t){t===void 0&&(t=this.clearScreenColor);var e=this.canvas.getContext("2d");e.fillStyle=t,e.fillRect(0,0,this.getWidth(),this.getHeight())},n.prototype.getHeight=function(){return this.canvas.height},n.prototype.getWidth=function(){return this.canvas.width},Object.defineProperty(n.prototype,"paused",{get:function(){return this.gameTimer.paused},set:function(t){t?this.audio.pauseAll():this.audio.resumeAll(),this.gameTimer.paused=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"playTime",{get:function(){return this.gameTimer.playTime},enumerable:!0,configurable:!0}),n.prototype.randomInt=function(t){var e=0;return Math.floor(Math.random()*(t-e+1)+e)},n.prototype.render=function(){var t=this.canvas.getContext("2d");this.state.render(t),this.showFps&&this._renderFps(t),this.statusMessage&&this.statusMessageAlpha>0&&this._renderStatusMessage(t)},n.prototype._renderFps=function(t){this.frames++;var e=Z.default.timestamp();e-this.lastTime>=xt&&(this.fpsMsg=this.frames+" fps",this.frames=0,this.lastTime=e);var i=10,s=15;t.font="10pt Arial",t.fillStyle=this.fpsColor,t.fillText(this.fpsMsg,i,s)},n.prototype._renderStatusMessage=function(t){if(this.statusMessage){var e=10,i=this.canvas.height-6;t.font="10pt Arial",t.fillStyle=this.statusMessageColor||"#fff",t.fillText(this.statusMessage,e,i)}},n.prototype.resetPlayTime=function(){this.gameTimer.resetPlayTime()},n.prototype.setState=function(t){this.state&&this.state.leaving(this),this.state=t,this.state.enter(this)},n.prototype.setStatusMessage=function(t){this.statusMessage=t,this.statusMessageAlpha=2,this.statusMessageTime=Z.default.timestamp()+Dt},n.prototype.start=function(){var t=this._tick.bind(this);this.gameTimer.start(),setInterval(t,this.interval)},n.prototype._tick=function(){if(this.statusMessage){var t=Z.default.timestamp();if(t>this.statusMessageTime){this.statusMessageTime=t+Dt,this.statusMessageAlpha-=ve;var e=Math.min(1,this.statusMessageAlpha);this.statusMessageColor="rgba("+this.statusMessageRGB+","+e+")",this.statusMessageAlpha<=0&&(this.statusMessage=null)}}this.update(),this.render()},n.prototype.toggleMuted=function(){var t=this.audio.toggleMuted();return this.setStatusMessage(t?"Audio muted":"Audio enabled"),t},n.prototype.toggleShowFps=function(){this.showFps=!this.showFps,this.setStatusMessage("FPS display: "+(this.showFps?"on":"off"))},n.prototype.update=function(){var t=this.inputManager;t.isKeyDown(Nt.Keys.KEY_SHIFT)&&t.isKeyDown(Nt.Keys.KEY_F,!0)&&this.toggleShowFps(),this.state.update(this.interval)},n}();et.default=ye;Object.defineProperty(B,"__esModule",{value:!0});var we=et,kt=function(){function n(t){if(t&&t instanceof we.default)this.game=t;else if(t)this.game=t.game;else{var e=window;this.game=e.game}}return n.prototype.enter=function(t){},n.prototype.leaving=function(t){},n.prototype.update=function(t){},n.prototype.render=function(t){},n}();B.State=kt;B.default=kt;var be=$&&$.__extends||function(){var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,s){i.__proto__=s}||function(i,s){for(var a in s)s.hasOwnProperty(a)&&(i[a]=s[a])},n(t,e)};return function(t,e){n(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}();Object.defineProperty(vt,"__esModule",{value:!0});var Oe=B,Ae=800,Le=function(n){be(t,n);function t(e,i,s,a){var r=n.call(this)||this;return r.leavingState=e,r.enteringState=i,r.transitionLogic=s,r.fadingOut=!0,r.alpha=1,r.halfTime=a&&a>0?a/2:Ae,r.curTime=0,r}return t.prototype.update=function(e){if(n.prototype.update.call(this,e),this.curTime+=e,this.curTime>=this.halfTime)if(this.curTime-=this.halfTime,this.fadingOut)this.fadingOut=!1,this.transitionLogic&&this.transitionLogic();else{this._setState(this.enteringState);return}this.alpha=this.fadingOut?1-this.curTime/this.halfTime:this.curTime/this.halfTime},t.prototype.render=function(e){n.prototype.render.call(this,e),this.game.clearScreen();var i=e.globalAlpha;e.globalAlpha=this.alpha,this.fadingOut?this.leavingState.render(e):this.enteringState.render(e),e.globalAlpha=i},t.prototype._setState=function(e){this.game.setState(this.enteringState)},t}(Oe.default);vt.default=Le;var yt={};Object.defineProperty(yt,"__esModule",{value:!0});var Ce=function(){function n(t,e){t===void 0&&(t=0),e===void 0&&(e=0),this.x=t,this.y=e}return n.prototype.equals=function(t){return!!t&&this.x===t.x&&this.y===t.y},n}();yt.default=Ce;var wt={};Object.defineProperty(wt,"__esModule",{value:!0});var Pe=function(){function n(t,e,i){e===void 0&&(e=20),i===void 0&&(i=10),this.c=t,this.pool=[];for(var s=0;s<e;s++)this.pool.push(new this.c);this.index=0,this.growCount=i}return n.prototype.borrowObj=function(){var t=this.pool[this.index++];if(this.index>=this.pool.length)for(var e=0;e<this.growCount;e++)this.pool.push(new this.c);return t},Object.defineProperty(n.prototype,"borrowedCount",{get:function(){return this.index},enumerable:!0,configurable:!0}),n.prototype.reset=function(){this.index=0},n.prototype.returnObj=function(t){for(var e=-1,i=0;i<this.index;i++)if(t===this.pool[i]){e=i;break}if(e===-1)return!1;var s=this.pool[--this.index];return this.pool[this.index]=this.pool[e],this.pool[e]=s,!0},Object.defineProperty(n.prototype,"length",{get:function(){return this.pool.length},enumerable:!0,configurable:!0}),n.prototype.toString=function(){return"[Pool: "+("borrowed="+this.borrowedCount+", ")+("size="+this.length)+"]"},n}();wt.default=Pe;var bt={};Object.defineProperty(bt,"__esModule",{value:!0});var Re=function(){function n(t,e,i,s){t===void 0&&(t=0),e===void 0&&(e=0),i===void 0&&(i=0),s===void 0&&(s=0),this.set(t,e,i,s)}return n.prototype.contains=function(t,e){return t>=this.x&&t<this.x+this.w&&e>=this.y&&e<this.y+this.h},n.prototype.containsRect=function(t,e,i,s){if(e===void 0&&(e=0),i===void 0&&(i=0),s===void 0&&(s=0),typeof t!="number"){var a=t;e=a.y,i=a.w,s=a.h,t=a.x}var r=this.w,o=this.h;if((r|o|i|s)<0)return!1;var h=this.x,l=this.y;if(t<h||e<l)return!1;if(r+=h,i+=t,i<=t){if(r>=h||i>r)return!1}else if(r>=h&&i>r)return!1;if(o+=l,s+=e,s<=e){if(o>=l||s>o)return!1}else if(o>=l&&s>o)return!1;return!0},n.prototype.intersects=function(t){var e=this.w,i=this.h,s=t.w,a=t.h;if(s<=0||a<=0||e<=0||i<=0)return!1;var r=this.x,o=this.y,h=t.x,l=t.y;return s+=h,a+=l,e+=r,i+=o,(s<h||s>r)&&(a<l||a>o)&&(e<r||e>h)&&(i<o||i>l)},n.prototype.set=function(t,e,i,s){typeof t=="number"?(this.x=t,typeof e<"u"&&(this.y=e),typeof i<"u"&&(this.w=i),typeof s<"u"&&(this.h=s)):(this.x=t.x,this.y=t.y,this.w=t.w,this.h=t.h)},n}();bt.default=Re;var rt={},at={};Object.defineProperty(at,"__esModule",{value:!0});var Me=function(){function n(t){var e=this;this.gid=t.gid||-1,this.name=t.name,this.x=t.x||0,this.y=t.y||0,this.width=t.width||0,this.height=t.height||0,this.type=t.type,this.visible=typeof t.visible>"u"?!0:t.visible,this.properties=t.properties||[];var i=window,s=i.game;this.x*=s.scale,this.y*=s.scale,this.width*=s.scale,this.height*=s.scale,this.propertiesByName={},this.properties.forEach(function(a){e.propertiesByName[a.name]=a})}return n.prototype.getProperty=function(t){return this.propertiesByName[t]?this.propertiesByName[t].value:null},n.prototype.intersects=function(t,e,i,s){var a=this.width,r=this.height,o=i,h=s;if(o<=0||h<=0||a<=0||r<=0)return!1;var l=this.x,c=this.y,d=t,S=e;return o+=d,h+=S,a+=l,r+=c,(o<d||o>l)&&(h<S||h>c)&&(a<l||a>d)&&(r<c||r>S)},n}();at.default=Me;Object.defineProperty(rt,"__esModule",{value:!0});var Ne=at,De=function(){function n(t,e){this.map=t,this.name=e.name,this.width=e.width,this.height=e.height,this.data=e.data,this.opacity=e.opacity,this.visible=e.visible,this.type=e.type,this.x=e.x,this.y=e.y,this.setObjects(e.objects)}return n.prototype.getData=function(t,e){if(!this.data)return-1;var i=this._getIndex(t,e);return this.data[i]},n.prototype.setData=function(t,e,i){if(!this.data)return!1;var s=this._getIndex(t,e);return this.data[s]=i,!0},n.prototype._getIndex=function(t,e){return t*this.map.colCount+e},n.prototype.getObjectByName=function(t){return this.objectsByName?this.objectsByName[t]:null},n.prototype.getObjectIntersecting=function(t,e,i,s){if(this.objects)for(var a=0;a<this.objects.length;a++){var r=this.objects[a];if(r.intersects(t,e,i,s))return r}return null},n.prototype.isObjectGroup=function(){return this.type==="objectgroup"},n.prototype.setObjects=function(t){if(t){this.objects=[],this.objectsByName={};for(var e=0;e<t.length;e++){var i=new Ne.default(t[e]);this.objects.push(i),this.objectsByName[t[e].name]=i}}},n}();rt.default=De;var Ot={},ot={};Object.defineProperty(ot,"__esModule",{value:!0});var xe=function(){function n(t,e){this.firstgid=t.firstgid,this.image=t.image,e&&(this.image=e(this.image)),this.imageWidth=t.imagewidth,this.imageHeight=t.imageheight,this.margin=t.margin,this.name=t.name,this.properties=t.properties,this.spacing=t.spacing,this.tileWidth=t.tilewidth,this.tileHeight=t.tileheight}return n.prototype.setScale=function(t){this.imageWidth*=t,this.imageHeight*=t,this.tileWidth*=t,this.tileHeight*=t,this.margin*=t,this.spacing*=t},n}();ot.default=xe;Object.defineProperty(Ot,"__esModule",{value:!0});var Ye=ot,Ge=rt,ke=function(){function n(t,e){var i=this;this.rowCount=t.height,this.colCount=t.width,this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight,this.screenWidth=e.screenWidth,this.screenHeight=e.screenHeight,this.screenRows=Math.ceil(this.screenHeight/this.tileHeight),this.screenCols=Math.ceil(this.screenWidth/this.tileWidth);var s=e?e.imagePathModifier:null;this.layers=[],this.layersByName={},this.objectGroups=[];for(var a=0;a<t.layers.length;a++)this.addLayer(t.layers[a]);if(this.tilesets=[],t.tilesets&&t.tilesets.length)for(var a=0;a<t.tilesets.length;a++)this.tilesets.push(new Ye.default(t.tilesets[a],s));this.properties=t.properties||[],this.version=t.version,this.orientation=t.orientation,this.propertiesByName={},this.properties.forEach(function(r){i.propertiesByName[r.name]=r})}return n.prototype.addLayer=function(t){var e=new Ge.default(this,t);this.layers.push(e),this.layersByName[e.name]=e,e.isObjectGroup()&&this.objectGroups.push(e)},n.prototype.draw=function(t,e,i,s,a){s===void 0&&(s=0),a===void 0&&(a=0);var r=this.colCount,o=this.rowCount;this.screenRows,this.screenCols;var h=this.tileWidth,l=this.tileHeight,c=h,d=this.screenWidth,S=this.screenHeight,T=i*h+s+h/2,E=e*l+a+l/2,N=T-d/2,D=E-S/2,x=Math.floor(N/h);N%c<0&&x--;var Ft=x*h,Y=Math.floor(D/l);D%c<0&&Y--;var Ut=Y*l,Lt=Ft-N,K=Lt,Wt=Ut-D,ut=Wt;x<0&&(x+=r),Y<0&&(Y+=o);for(var Ct=Y,Bt=this.getLayerCount();ut<S;){for(var lt=0;lt<Bt;lt++){var Pt=x;K=Lt;var R=this.getLayerByIndex(lt);if(R.visible){var ct=1;for(R.opacity<1&&(ct=t.globalAlpha,t.globalAlpha=ct*R.opacity);K<d;){var Kt=R.getData(Ct%o,Pt%r);this.drawTile(t,K,ut,Kt,R),K+=h,Pt++}R.opacity<1&&(t.globalAlpha=ct)}}ut+=l,Ct++}},n.prototype.getLayer=function(t){return this.layersByName[t]},n.prototype.getLayerByIndex=function(t){return this.layers[t]},n.prototype.getLayerCount=function(){return this.layers.length},n.prototype._getImageForGid=function(t){for(var e=this.tilesets.length,i=0;i<e;i++)if(this.tilesets[i].firstgid>t)return this.tilesets[i-1];return this.tilesets[e-1]},n.prototype.getProperty=function(t){return this.propertiesByName[t]?this.propertiesByName[t].value:null},n.prototype.drawTile=function(t,e,i,s,a){if(!(s<=0)){var r=this._getImageForGid(s);if(!r){console.log("null tileset for: "+s+" (layer "+a.name+")");return}if(s-=r.firstgid,!(s<0)){var o=window,h=o.game,l=h.assets.getTmxTilesetImage(r),c=this.tileWidth,d=c+r.spacing,S=this.tileHeight,T=S+r.spacing,E=Math.floor(l.width/d);r.spacing>0&&l.width%d===c&&E++;var N=Math.floor(s/E)*T,D=s%E*d;l.drawScaled2(t,D,N,c,S,e,i,c,S)}}},n.prototype.setScale=function(t){this.tileWidth*=t,this.tileHeight*=t,this.screenRows=Math.ceil(this.screenHeight/this.tileHeight),this.screenCols=Math.ceil(this.screenWidth/this.tileWidth);for(var e=this.tilesets.length,i=0;i<e;i++)this.tilesets[i].setScale(t)},n.prototype.getPixelWidth=function(){return this.colCount*this.tileWidth},n.prototype.getPixelHeight=function(){return this.rowCount*this.tileHeight},n.prototype.removeLayer=function(t){for(var e=0;e<this.layers.length;e++){if(this.layers[e].name===t){this.layers.splice(e,1),delete this.layersByName[t];for(var i=0;i<this.objectGroups.length;i++)this.objectGroups[i].name===t&&delete this.objectGroups[i]}return!0}return!1},n}();Ot.default=ke;Object.defineProperty(p,"__esModule",{value:!0});var He=q;p.AssetLoader=He.default;var Fe=mt;p.AssetType=Fe.AssetType;var Ue=tt;p.AudioSystem=Ue.default;var We=St;p.BitmapFont=We.default;var Be=J;p.BrowserUtil=Be.default;var Ke=_t,Yt=p.CanvasResizer=Ke.default,je=Et;p.Delay=je.default;var Xe=vt,Ze=p.FadeOutInState=Xe.default,$e=et,Ve=p.Game=$e.default,qe=W;p.Image=qe.default;var Je=z;p.ImageAtlas=Je.default;var Qe=P,ze=p.ImageUtils=Qe.default,ti=st;p.InputManager=ti.default;var ei=it,v=p.Keys=ei.Keys,ii=yt,k=p.Point=ii.default,si=wt,ni=p.Pool=si.default,ri=bt,Gt=p.Rectangle=ri.default,ai=Q;p.Sound=ai.default;var oi=U;p.SpriteSheet=oi.default;var hi=B,ui=p.State=hi.State,li=Tt,L=p.StretchMode=li.StretchMode,ci=nt;p.Timer=ci.default;var di=C,H=p.Utils=di.default,fi=rt;p.TiledLayer=fi.default;var pi=Ot;p.TiledMap=pi.default;var gi=at;p.TiledObject=gi.default;var mi=ot;p.TiledTileset=mi.default;const m={CHASING_GHOSTS:"chasingGhosts",CHOMP_1:"chomp1",CHOMP_2:"chomp2",DIES:"dies",EATING_FRUIT:"eatingFruit",EATING_GHOST:"eatingGhost",EXTRA_LIFE:"extraLife",INTERMISSION:"intermission",EYES_RUNNING:"eyesRunning",OPENING:"opening",SIREN:"siren",TOKEN:"token"};var u=(n=>(n[n.EAST=0]="EAST",n[n.SOUTH=1]="SOUTH",n[n.WEST=2]="WEST",n[n.NORTH=3]="NORTH",n))(u||{});class ft{constructor(t=0,e=0){this.row=t,this.col=e}equals(t){return this.row===t.row&&this.col===t.col}set(t,e,i){this.row=t,this.col=e,this.parent=i}toString(){return"[MazeNode: ("+this.row+","+this.col+")]"}}const V=class V{};V.SPRITE_SIZE=16,V.TILE_SIZE=8;let f=V;const Si=[50,10];class g{constructor(t){this.closed=[],this.open=[],this.goalNode=new ft,this.data=[],this.reset(t)}static _cloneObjectOfPrimitives(t){return JSON.parse(JSON.stringify(t))}checkForDot(t,e){let i=0;const s=this.getTileAt(t,e);return s>=254&&(game.playChompSound(),s===254&&game.makeGhostsBlue(),this.eatenDotCount++,this.data[t][e]=0,i=Si[s-254],this.eatenDotCount===g.FRUIT_DOT_COUNT&&game.addFruit(),this.eatenDotCount===this.dotCount&&game.loadNextLevel()),i}static _constructPath(t){let e=null;for(;t.parent;)e=t,t=t.parent;return e}static get FRUIT_DOT_COUNT(){return 64}static _getNextColumn(t){return++t===g.TILE_COUNT_HORIZONTAL&&(t=0),t}getPathBreadthFirst(t,e,i,s){this.open.forEach(r=>{this.data[r.row][r.col]&=255}),this.closed.forEach(r=>{this.data[r.row][r.col]&=255}),this.open.length=0,this.closed.length=0,this.goalNode.set(i,s,null);let a=this.nodeCache.borrowObj();for(this.open.push(new ft(t,e)),this.data[t][e]|=256;this.open.length>0;){const r=this.open.splice(0,1)[0];if(r.equals(this.goalNode))return this.data[r.row][r.col]&=255,g._constructPath(r);{this.closed.push(r),this.isWalkable(r.row-1,r.col)&&(this.data[r.row-1][r.col]&256||(this.data[r.row-1][r.col]|=256,a.set(r.row-1,r.col,r),this.open.push(a),a=this.nodeCache.borrowObj())),this.isWalkable(r.row+1,r.col)&&(this.data[r.row+1][r.col]&256||(this.data[r.row+1][r.col]|=256,a.set(r.row+1,r.col,r),this.open.push(a),a=this.nodeCache.borrowObj()));let o=g._getPreviousColumn(r.col);this.isWalkable(r.row,o)&&(this.data[r.row][o]&256||(this.data[r.row][o]|=256,a.set(r.row,o,r),this.open.push(a),a=this.nodeCache.borrowObj())),o=g._getNextColumn(r.col),this.isWalkable(r.row,o)&&(this.data[r.row][o]&256||(this.data[r.row][o]|=256,a.set(r.row,o,r),this.open.push(a),a=this.nodeCache.borrowObj()))}}throw new Error("No path found from ("+t+", "+e+") to ("+i+", "+s+")")}static _getPreviousColumn(t){return t===0&&(t=g.TILE_COUNT_HORIZONTAL),t-1}static get TILE_COUNT_HORIZONTAL(){return 28}static get TILE_COUNT_VERTICAL(){return 32}static get TILE_DOT_BIG(){return 254}static get TILE_DOT_SMALL(){return 255}getTileAt(t,e){return e<0||e>=g.TILE_COUNT_HORIZONTAL||t<0||t>=g.TILE_COUNT_VERTICAL?-1:this.data[t][e]&255}isClearShotColumn(t,e,i){const s=Math.min(e,i),a=Math.max(e,i);for(let r=s+1;r<a;r++)if(!this.isWalkable(r,t))return!1;return!0}isClearShotRow(t,e,i){const s=Math.min(e,i),a=Math.max(e,i);for(let r=s+1;r<a;r++)if(!this.isWalkable(t,r))return!1;return!0}isWalkable(t,e){const i=this.getTileAt(t,e);return i===0||i>=240}render(t){t.drawImage(this.mazeCanvas,0,0);const e=8;t.fillStyle="#ffffff";for(let i=0;i<g.TILE_COUNT_VERTICAL;i++){const s=i*e+2*e;for(let a=0;a<g.TILE_COUNT_HORIZONTAL;a++){const r=this.getTileAt(i,a),o=a*e;r===g.TILE_DOT_SMALL?game.drawSmallDot(o+3,s+2):r===g.TILE_DOT_BIG&&game.drawBigDot(o,s)}}}reset(t){const e=f.TILE_SIZE,i=t!=null;if(i&&(this.origMazeInfo=g._cloneObjectOfPrimitives(t)),this.data=g._cloneObjectOfPrimitives(this.origMazeInfo),this.eatenDotCount=0,i){const s=game.assets.get("mapTiles"),a=2*e;this.mazeCanvas=ze.createCanvas(game.getWidth(),game.getHeight());const r=this.mazeCanvas.getContext("2d");let o=0;this.dotCount=0,r.fillStyle="#000000",r.fillRect(0,0,this.mazeCanvas.width,this.mazeCanvas.height),game.drawScoresHeaders(r);for(let h=0;h<this.data.length;h++){const l=this.data[h];for(let c=0;c<l.length;c++){let d=l[c];switch((d===0||d>=240)&&o++,d){case g.TILE_DOT_SMALL:case g.TILE_DOT_BIG:this.dotCount++;break;default:if(d--,d>-1){const S=c*e,T=a+h*e;s.drawByIndex(r,S,T,d)}break}}}this.nodeCache||(this.nodeCache=new ni(ft,o))}}}class At{constructor(t){this.bounds=new Gt(0,0,f.SPRITE_SIZE,f.SPRITE_SIZE),this._intersectBounds=new Gt,this.direction=u.EAST,this._frame=0,this._frameCount=t,this._lastUpdateTime=0}atIntersection(t){switch(this.direction){case u.NORTH:case u.SOUTH:return this.getCanMoveLeft(t)||this.getCanMoveRight(t);case u.EAST:case u.WEST:return this.getCanMoveUp(t)||this.getCanMoveDown(t)}}getCanMoveDown(t){const e=this.centerX,i=this.centerY,s=e%this.TILE_SIZE,a=i%this.TILE_SIZE;if(s===0&&a===0){const r=this.row,o=this.column;return r<30&&t.isWalkable(r+1,o)}return this.direction===u.NORTH||this.direction===u.SOUTH}getCanMoveLeft(t){let e=this.bounds.x;if(e<0)return!0;e+=this.TILE_SIZE/2;const i=this.centerY,s=e%this.TILE_SIZE,a=i%this.TILE_SIZE;if(s===0&&a===0){const r=this.row,o=this.column;return o>0&&t.isWalkable(r,o-1)}return this.direction===u.EAST||this.direction===u.WEST}getCanMoveRight(t){let e=this.bounds.x;if(e+this.width>this.SCREEN_WIDTH)return!0;e+=this.TILE_SIZE/2;const i=this.centerY,s=e%this.TILE_SIZE,a=i%this.TILE_SIZE;if(s===0&&a===0){const r=this.row,o=this.column;return o<27&&t.isWalkable(r,o+1)}return this.direction===u.EAST||this.direction===u.WEST}getCanMoveUp(t){const e=this.centerX,i=this.centerY;(e%1!==0||i%1!==0)&&console.error("Unexpected condition: x === "+e+", y === "+i);const s=e%this.TILE_SIZE,a=i%this.TILE_SIZE;if(s===0&&a===0){const r=this.row,o=this.column;return r>0&&t.isWalkable(r-1,o)}return this.direction===u.NORTH||this.direction===u.SOUTH}get centerX(){return this.bounds.x+this.TILE_SIZE/2}get centerY(){return this.bounds.y+this.TILE_SIZE/2}get column(){let t=Math.floor(this.centerX/this.TILE_SIZE);return t<0?t+=g.TILE_COUNT_HORIZONTAL:t>=g.TILE_COUNT_HORIZONTAL&&(t-=g.TILE_COUNT_HORIZONTAL),t}getFrame(){return this._frame}getFrameCount(){return this._frameCount}get intersectBounds(){return this._intersectBounds.set(this.bounds.x+2,this.bounds.y-2,this.bounds.w-4,this.bounds.h-4),this._intersectBounds}get moveAmount(){return 1}get TILE_SIZE(){return 8}get width(){return this.bounds.w}get row(){return Math.floor(this.centerY/this.TILE_SIZE)}get x(){return this.bounds.x}get y(){return this.bounds.y}goDownIfPossible(t,e){return this.getCanMoveDown(t)?(this.direction=u.SOUTH,this.incY(e),!0):!1}goLeftIfPossible(t,e){return this.getCanMoveLeft(t)?(this.direction=u.WEST,this.incX(-e),!0):!1}goRightIfPossible(t,e){return this.getCanMoveRight(t)?(this.direction=u.EAST,this.incX(e),!0):!1}goUpIfPossible(t,e){return this.getCanMoveUp(t)?(this.direction=u.NORTH,this.incY(-e),!0):!1}incX(t){this.bounds.x+=t,this.bounds.x+this.width<=0?this.bounds.x+=this.SCREEN_WIDTH:this.bounds.x>=this.SCREEN_WIDTH&&(this.bounds.x-=this.SCREEN_WIDTH)}incY(t){this.bounds.y+=t}intersects(t){return this.intersectBounds.intersects(t.intersectBounds)}reset(){this._lastUpdateTime=0}get SCREEN_WIDTH(){return 224}setLocation(t,e){this.bounds.x=t,this.bounds.y=e}updateFrame(){this._frame=(this._frame+1)%this.getFrameCount()}updatePosition(t,e){e>this._lastUpdateTime+this.getUpdateDelayMillis()&&(this._lastUpdateTime=e,this.updatePositionImpl(t))}set x(t){this.bounds.x=t}set y(t){this.bounds.y=t}}class _i extends At{constructor(){super(3),this._dyingFrame=0}getUpdateDelayMillis(){return 10}handleInput(t){const e=game.inputManager;e.left()?this.getCanMoveLeft(t)&&(this.direction=u.WEST):e.right()&&this.getCanMoveRight(t)&&(this.direction=u.EAST),e.up()?this.getCanMoveUp(t)&&(this.direction=u.NORTH):e.down()&&this.getCanMoveDown(t)&&(this.direction=u.SOUTH)}incDying(){return this._dyingFrame=(this._dyingFrame+1)%12,this._dyingFrame!==0}render(t){const e=f.SPRITE_SIZE,i=this.bounds.x,s=this.bounds.y;let a,r;this._dyingFrame>0?(a=e*this._dyingFrame,r=96):(a=this.direction*e*this.getFrameCount()+this.getFrame()*e,r=80),game.drawSprite(i,s,a,r)}reset(){super.reset(),this.direction=u.WEST,this.setLocation(13*8,24*8-8/2),this._frame=0}setLocation(t,e){super.setLocation(t,e)}startDying(){this._dyingFrame=1}updatePositionImpl(t){const e=this.moveAmount;switch(this.direction){case u.WEST:this.goLeftIfPossible(t,e);break;case u.EAST:this.goRightIfPossible(t,e);break;case u.NORTH:this.goUpIfPossible(t,e);break;case u.SOUTH:this.goDownIfPossible(t,e);break}game.increaseScore(t.checkForDot(this.row,this.column))}}const y=class y extends At{constructor(){super(1),this.setLocation(game.PENALTY_BOX_EXIT_X,140);let t=game.level;t>7&&(t=game.randomInt(8)),this._col=y.COLS[t],this._row=y.ROWS[t],this._pointsIndex=y.PTS_INDEX[t]}get pointsIndex(){return this._pointsIndex}getUpdateDelayMillis(){return 1e11}paint(t){const e=f.SPRITE_SIZE,i=this._col*e,s=this._row*e;game.drawSprite(this.x,this.y,i,s)}updatePositionImpl(t){}};y.COLS=[12,13,12,13,13,12,13,13],y.ROWS=[4,4,5,5,2,6,6,3],y.PTS_INDEX=[0,2,4,5,10,7,9,11];let gt=y;const pt=.5;var _=(n=>(n[n.IN_BOX=0]="IN_BOX",n[n.LEAVING_BOX=1]="LEAVING_BOX",n[n.CHASING_PACMAN=2]="CHASING_PACMAN",n[n.SCATTERING=3]="SCATTERING",n[n.BLUE=4]="BLUE",n[n.EYES=5]="EYES",n[n.EYES_ENTERING_BOX=6]="EYES_ENTERING_BOX",n))(_||{});class ht extends At{constructor(t,e,i){super(2),this.game=t,this.corner=new k,this.spriteSheetY=e,this.exitDelaySeconds=i,this.reset()}changeDirectionFallback(t){const e=this.moveAmount;switch(H.randomInt(4)){case 0:this.goUpIfPossible(t,e)||this.goLeftIfPossible(t,e)||this.goRightIfPossible(t,e)||this.goDownIfPossible(t,e);break;case 1:this.goLeftIfPossible(t,e)||this.goUpIfPossible(t,e)||this.goDownIfPossible(t,e)||this.goRightIfPossible(t,e);break;case 2:this.goDownIfPossible(t,e)||this.goLeftIfPossible(t,e)||this.goRightIfPossible(t,e)||this.goUpIfPossible(t,e);break;case 3:this.goRightIfPossible(t,e)||this.goUpIfPossible(t,e)||this.goDownIfPossible(t,e)||this.goLeftIfPossible(t,e);break}}continueInCurrentDirection(t){switch(this.direction){case u.NORTH:this.incY(-t);break;case u.WEST:this.incX(-t);break;case u.SOUTH:this.incY(t);break;case u.EAST:this.incX(t);break}}getBlueTimeForLevel(t){switch(t){case 0:case 1:return 8e3;case 2:case 3:return 6e3;case 4:case 5:return 4e3;case 6:case 7:return 2e3;default:return 0}}getFirstExitDelayMillis(){return this.exitDelaySeconds*1e3}getFrameCount(){return 2}get motionState(){return this._motionState}getUpdateDelayMillis(){switch(this._motionState){case 4:return 25;case 5:case 6:return 10;default:return 10}}isBlue(){return this._motionState===4}isEyes(){return this._motionState===5||this._motionState===6}paint(t){const e=this.bounds.x,i=this.bounds.y,s=f.SPRITE_SIZE;let a,r;switch(this._motionState){case 4:a=(10+this.getFrame())*s,r=3*s;const o=game.playTime;this.exitBlueTime-o<=1e3&&o/250&1&&(r+=s),game.drawSprite(e,i,a,r);break;case 5:case 6:a=this.direction*s,r=4*s,game.drawSprite(e,i,a,r);break;default:a=this.direction*s*this.getFrameCount()+this.getFrame()*s,r=this.spriteSheetY,game.drawSprite(e,i,a,r);break}}possiblyTurnBlue(){switch(this._motionState){case 2:case 3:case 4:return this._motionState=4,!0;default:return!1}}reset(){super.reset(),this.scatterCount=0}setCorner(t){this.corner.x=t.x,this.corner.y=t.y}set motionState(t){const e=this.game;if(t===3)switch(this.scatterCount++){case 0:case 1:this.exitScatteringTime=e.playTime+7e3,this._motionState=t;break;case 2:case 3:this.exitScatteringTime=e.playTime+5e3,this._motionState=t;break;default:this._motionState=2;break}else if(t===4){const i=this.getBlueTimeForLevel(e.level),s=e.playTime;switch(this.exitBlueTime=s+i,this._motionState){case 2:this.previousState=this._motionState,this.startScatteringTime+=i;break;case 3:this.previousState=this._motionState,this.exitScatteringTime+=i;break;case 4:const a=this.exitBlueTime-s;switch(this.previousState){case 2:this.startScatteringTime+=a+i;break;case 3:this.exitScatteringTime+=a+i;break}break;default:throw new Error("Unexpected state: "+this._motionState)}this._motionState=t}else this._motionState===2&&(this.startScatteringTime=e.playTime+2e4),this._motionState=t;this.game.checkLoopedSound()}updatePositionBlue(t){const e=this.moveAmount;if(this.atIntersection(t)){const i=game.pacman,s=i.row,a=i.column,r=this.row,o=this.column;let h=!1;r===s&&t.isClearShotRow(r,o,a)?(this.goUpIfPossible(t,e)||this.goDownIfPossible(t,e)||(a<o?this.goRightIfPossible(t,e)||(this.direction=u.WEST,this.incX(-e)):this.goLeftIfPossible(t,e)||(this.direction=u.EAST,this.incX(e))),h=!0):o===a&&t.isClearShotColumn(o,r,s)&&(this.goLeftIfPossible(t,e)||this.goRightIfPossible(t,e)||(s<r?this.goDownIfPossible(t,e)||(this.direction=u.NORTH,this.incY(-e)):this.goUpIfPossible(t,e)||(this.direction=u.SOUTH,this.incY(e))),h=!0),h||this.changeDirectionFallback(t)}else this.continueInCurrentDirection(e);game.playTime>=this.exitBlueTime&&(this._motionState=this.previousState)}updatePositionEyes(t){const e=this.moveAmount;if(this.atIntersection(t)){const i=this.row,s=this.column,a=Math.floor((game.PENALTY_BOX_EXIT_Y+8)/f.TILE_SIZE);let r=Math.floor(game.PENALTY_BOX_EXIT_X/f.TILE_SIZE);s<=r&&r++;const o=t.getPathBreadthFirst(i,s,a,r);o==null?this._motionState=6:o.col<s?(this.direction=u.WEST,this.incX(-e)):o.col>s?(this.direction=u.EAST,this.incX(e)):o.row<i?(this.direction=u.NORTH,this.incY(-e)):o.row>i&&(this.direction=u.SOUTH,this.incY(e))}else{const i=this.row,s=Math.floor((game.PENALTY_BOX_EXIT_Y+8)/f.TILE_SIZE);i===s&&this.x===game.PENALTY_BOX_EXIT_X?this._motionState=6:this.continueInCurrentDirection(e)}}updatePositionEyesEnteringBox(t){const e=pt;this.y<game.PENALTY_BOX_EXIT_Y+3*f.SPRITE_SIZE/2?(this.direction=u.SOUTH,this.incY(e)):this._motionState=1}updatePositionImpl(t){switch(this._motionState){case 0:this.updatePositionInBox(t);break;case 1:this.updatePositionLeavingBox(t);break;case 3:this.updatePositionScattering(t);break;case 2:this.updatePositionChasingPacman(t);break;case 4:this.updatePositionBlue(t);break;case 5:this.updatePositionEyes(t);break;case 6:this.updatePositionEyesEnteringBox(t);break}}updatePositionInBox(t){const e=pt;switch(this.direction){case u.WEST:case u.NORTH:this.y>112?this.incY(-e):this.direction=u.SOUTH;break;case u.EAST:case u.SOUTH:this.y<120?this.incY(e):this.direction=u.NORTH;break}game.playTime>=this.getFirstExitDelayMillis()&&(this._motionState=1)}updatePositionLeavingBox(t){const e=pt,i=this.x;if(i<game.PENALTY_BOX_EXIT_X)this.direction=u.EAST,this.incX(e);else if(i>game.PENALTY_BOX_EXIT_X)this.direction=u.WEST,this.incX(-e);else{let s=this.y-e;this.y=s,s<=game.PENALTY_BOX_EXIT_Y?(s=game.PENALTY_BOX_EXIT_Y,this._motionState=3,this.direction=u.WEST):this.direction=u.NORTH}}updatePositionScattering(t){const e=this.moveAmount;if(this.atIntersection(t)){const i=this.row,s=this.column,a=this.corner.x,r=this.corner.y,o=t.getPathBreadthFirst(i,s,a,r);o?o.col<s?(this.direction=u.WEST,this.incX(-e)):o.col>s?(this.direction=u.EAST,this.incX(e)):o.row<i?(this.direction=u.NORTH,this.incY(-e)):o.row>i&&(this.direction=u.SOUTH,this.incY(e)):this.changeDirectionFallback(t)}else this.continueInCurrentDirection(e);game.playTime>=this.exitScatteringTime&&(this._motionState=2)}}class Ti extends ht{constructor(t){super(t,0*f.SPRITE_SIZE,0)}reset(){super.reset(),this.direction=u.WEST,this.setLocation(this.game.PENALTY_BOX_EXIT_X,this.game.PENALTY_BOX_EXIT_Y),this.motionState=_.SCATTERING}updatePositionChasingPacman(t){const e=this.moveAmount;if(this.atIntersection(t)){const i=this.row,s=this.column,a=this.game.pacman.row,r=this.game.pacman.column,o=t.getPathBreadthFirst(i,s,a,r);o==null?this.changeDirectionFallback(t):o.col<s?(this.direction=u.WEST,this.incX(-e)):o.col>s?(this.direction=u.EAST,this.incX(e)):o.row<i?(this.direction=u.NORTH,this.incY(-e)):o.row>i&&(this.direction=u.SOUTH,this.incY(e))}else this.continueInCurrentDirection(e);this.game.playTime>=this.startScatteringTime&&(this.motionState=_.SCATTERING)}}class Ei extends ht{constructor(t){super(t,2*f.SPRITE_SIZE,2)}reset(){super.reset(),this.direction=u.NORTH,this.setLocation(14*f.TILE_SIZE-f.TILE_SIZE/2-4,15*f.TILE_SIZE-f.TILE_SIZE/2),this.motionState=_.IN_BOX}updatePositionChasingPacman(t){const e=this.moveAmount,i=game.pacman,s=i.row,a=i.column,r=this.row,o=this.column;let h=!1;this.atIntersection(t)?(r===s&&t.isClearShotRow(r,o,a)?(a<o?(this.direction=u.WEST,this.incX(-e)):this.goRightIfPossible(t,e)||this.changeDirectionFallback(t),h=!0):o===a&&t.isClearShotColumn(o,r,s)&&(s<r?(this.direction=u.NORTH,this.incY(-e)):this.goDownIfPossible(t,e)||this.changeDirectionFallback(t),h=!0),h||this.changeDirectionFallback(t)):this.continueInCurrentDirection(e),game.playTime>=this.startScatteringTime&&(this.motionState=_.SCATTERING)}}class vi extends ht{constructor(t){super(t,1*f.SPRITE_SIZE,8)}reset(){super.reset(),this.direction=u.SOUTH,this.setLocation(12*f.TILE_SIZE-f.TILE_SIZE/2-4,15*f.TILE_SIZE-f.TILE_SIZE/2),this.motionState=_.IN_BOX}updatePositionChasingPacman(t){const e=this.moveAmount;if(this.atIntersection(t)){const i=this.row,s=this.column,a=game.getGhost(0),r=a.row,o=a.column;if((o-s)*(o-s)+(r-i)*(r-i)<=35){const l=game.pacman.row,c=game.pacman.column,d=t.getPathBreadthFirst(i,s,l,c);d==null?this.changeDirectionFallback(t):d.col<s?(this.direction=u.WEST,this.incX(-e)):d.col>s?(this.direction=u.EAST,this.incX(e)):d.row<i?(this.direction=u.NORTH,this.incY(-e)):d.row>i&&(this.direction=u.SOUTH,this.incY(e))}else this.changeDirectionFallback(t)}else this.continueInCurrentDirection(e);game.playTime>=this.startScatteringTime&&(this.motionState=_.SCATTERING)}}class Ii extends ht{constructor(t){super(t,3*f.SPRITE_SIZE,14)}reset(){super.reset(),this.direction=u.SOUTH,this.setLocation(16*f.TILE_SIZE-f.TILE_SIZE/2-4,15*f.TILE_SIZE-f.TILE_SIZE/2),this.motionState=_.IN_BOX}updatePositionChasingPacman(t){const e=this.moveAmount;this.atIntersection(t)?this.changeDirectionFallback(t):this.continueInCurrentDirection(e),game.playTime>=this.startScatteringTime&&(this.motionState=_.SCATTERING)}}class M extends ui{constructor(t){super(t),this._lastConfigKeypressTime=H.timestamp(),this._lastSpriteFrameTime=0}static get INPUT_REPEAT_MILLIS(){return 200}handleDefaultKeys(){const t=H.timestamp(),e=this.game.inputManager;if(t>this._lastConfigKeypressTime+M.INPUT_REPEAT_MILLIS&&(e.isKeyDown(v.KEY_M,!0)&&(game.toggleMuted(),this._lastConfigKeypressTime=t),e.isKeyDown(v.KEY_Z)))if(e.isKeyDown(v.KEY_P,!0)){const i=game.canvas.style;i.width||(i.width=game.canvas.width+"px"),i.height||(i.height=game.canvas.height+"px"),i.width=parseInt(i.width.substring(0,i.width.length-2),10)+1+"px",i.height=parseInt(i.height.substring(0,i.height.length-2),10)+1+"px",game.setStatusMessage(`Canvas size now: (${i.width}, ${i.height})`),this._lastConfigKeypressTime=t}else if(e.isKeyDown(v.KEY_L,!0)){const i=game.canvas.style;i.width||(i.width=game.canvas.width+"px"),i.height||(i.height=game.canvas.height+"px"),i.width=parseInt(i.width.substring(0,i.width.length-2),10)-1+"px",i.height=parseInt(i.height.substring(0,i.height.length-2),10)-1+"px",game.setStatusMessage(`Canvas size now: (${i.width}, ${i.height})`),this._lastConfigKeypressTime=t}else e.isKeyDown(v.KEY_G,!0)?(game.toggleGodMode(),this._lastConfigKeypressTime=t):e.isKeyDown(v.KEY_S,!0)&&game.toggleStretchMode()}_updateSpriteFrames(){const t=game.playTime;t>=this._lastSpriteFrameTime+100&&(this._lastSpriteFrameTime=t,game.updateSpriteFrames())}}class Ht extends M{constructor(t){super(t),this._initSprites(),this.handleStart=this.handleStart.bind(this)}enter(){super.enter(game),game.canvas.addEventListener("touchstart",this.handleStart,{capture:!1,passive:!0}),this.choice=0,this.lastKeypressTime=game.playTime,this._initSprites()}_initSprites(){const t=game.pacman;t.setLocation(game.getWidth()/2,240),t.direction=u.EAST;const e=game.getGhost(0);e.setLocation(game.getWidth()/2-3*f.SPRITE_SIZE,240),e.direction=u.EAST}leaving(t){t.canvas.removeEventListener("touchstart",this.handleStart,!1)}handleStart(){this.startGame()}render(t){const e=game.getWidth(),i=game.getHeight(),s=9;this.renderStaticStuff(t);let a=(e-s*15)/2-5,r=(i-15*2)/2;this.game.drawString(a,r+this.choice*15,">"),a+=s*1.5,r=200,game.canvas.getContext("2d").fillStyle="#ffffff",game.drawSmallDot(a+3,r+2),r+=9,game.drawBigDot(a,r),game.pacman.render(t),game.getGhost(0).paint(t),game.audio.isInitialized()||this.renderNoSoundMessage()}stringWidth(t){return game.assets.get("font").cellW*t.length}renderNoSoundMessage(){const t=game.getWidth();let e="SOUND IS DISABLED AS",i=(t-this.stringWidth(e))/2,s=game.getHeight()-20-9*3;this.game.drawString(i,s,e),e="YOUR BROWSER DOES NOT",i=(t-this.stringWidth(e))/2,s+=9,this.game.drawString(i,s,e),e="SUPPORT WEB AUDIO",i=(t-this.stringWidth(e))/2,s+=9,this.game.drawString(i,s,e)}renderStaticStuff(t){const e=this.game;e.clearScreen("rgb(0,0,0)");const i=e.getWidth(),s=9;e.drawScores(t),e.drawScoresHeaders(t);const a=e.assets.get("title");let r=(i-a.width)/2,o=a.height*1.2;a.draw(t,r,o);let h="STANDARD MAZE",l=h.length-1;r=(i-s*l)/2-5,o=(e.getHeight()-15*2)/2,this.game.drawString(r,o,h,t),h="ALTERNATE MAZE",o+=15,this.game.drawString(r,o,h,t),r+=s*2,h="10 POINTS",l=h.length-2,o=200,this.game.drawString(r,o,h,t),h="50 POINTS",o+=9,this.game.drawString(r,o,h,t),h="2015 OLD MAN GAMES",r=(i-s*h.length)/2,o=e.getHeight()-20,this.game.drawString(r,o,h,t)}startGame(){game.startGame(this.choice)}update(t){this.handleDefaultKeys();const e=game.playTime;if(e>this.lastKeypressTime+M.INPUT_REPEAT_MILLIS+100){const r=game.inputManager;r.up()?(this.choice=Math.abs(this.choice-1),game.audio.playSound(m.TOKEN),this.lastKeypressTime=e):r.down()?(this.choice=(this.choice+1)%2,game.audio.playSound(m.TOKEN),this.lastKeypressTime=e):r.enter(!0)&&this.startGame()}const i=game.pacman,s=game.getGhost(0);let a=i.moveAmount;i.direction===u.WEST&&(a=-a),i.incX(a),a=s.moveAmount,s.direction===u.WEST&&(a=-a),s.incX(a),i.x+i.width>=this.game.getWidth()-30?i.direction=s.direction=u.WEST:s.x<=30&&(i.direction=s.direction=u.EAST),this._updateSpriteFrames()}}class I extends M{constructor(t){super(),this._mazeFile=t}static get DYING_FRAME_DELAY_MILLIS(){return 75}get readyDelayMillis(){return this.firstTimeThrough?4500:2e3}enter(){game.pacman.reset(),game.resetGhosts(),this.maze=new g(this._mazeFile),this.firstTimeThrough=!0,this.updateScoreIndex=-1,this.lastMazeScreenKeypressTime=game.playTime+I.INPUT_REPEAT_MILLIS,this.substate="READY",this.firstTimeThrough=!0,this.substateStartTime=0,this.nextDyingFrameTime=0,this.nextUpdateTime=0,this._lastSpriteFrameTime=0}paintExtraLives(t){const s=game.lives;if(s>0){let a=24;const r=game.getHeight()-2*8,o=2*8;for(let h=0;h<s;h++)game.drawSprite(a,r,12*16,3*16),a+=o}}paintPossibleFruits(t){const i=f.TILE_SIZE,s=game.getWidth()-12-2*i,a=game.getHeight()-2*i;switch(game.level){default:case 7:game.drawSprite(s-112,a,13*16,3*16);case 6:game.drawSprite(s-96,a,13*16,6*16);case 5:game.drawSprite(s-80,a,12*16,6*16);case 4:game.drawSprite(s-64,a,13*16,2*16);case 3:game.drawSprite(s-48,a,13*16,5*16);case 2:game.drawSprite(s-32,a,12*16,5*16);case 1:game.drawSprite(s-16,a,13*16,4*16);case 0:game.drawSprite(s,a,12*16,4*16);break}}render(t){super.render(t),this.maze.render(t);const e=8,i=game.getHeight()-2*e-g.TILE_COUNT_VERTICAL*e;t.translate(0,i),game.drawFruit(t);const s=game.pacman;if(this.updateScoreIndex===-1)this.substate!=="GAME_OVER"&&s.render(t);else{const a=s.bounds.x,r=s.bounds.y;game.paintPointsEarned(t,this.updateScoreIndex,a,r)}if(game.drawGhosts(t),t.translate(0,-i),game.drawScores(t),this.paintExtraLives(t),this.paintPossibleFruits(t),this.substate==="READY"){const a="READY!";let r=(game.getWidth()-a.length*9)/2;r+=3,game.drawString(r,160,a)}else if(this.substate==="GAME_OVER"){const a="GAME OVER",r=(game.getWidth()-a.length*9)/2;game.drawString(r,160,a)}if(game.paused){t.globalAlpha=.4,t.fillStyle="black",t.fillRect(0,0,game.getWidth(),game.getHeight()),t.globalAlpha=1,t.fillRect(50,100,game.getWidth()-100,game.getHeight()-200);const a="PAUSED",r=(game.getWidth()-a.length*9)/2;game.drawString(r,(game.getHeight()-18)/2,a)}}reset(){this.maze.reset(),game.resetPlayTime(),game.pacman.reset(),game.resetGhosts(),this.substate="READY",this.substateStartTime=0,this._lastSpriteFrameTime=0,this.lastMazeScreenKeypressTime=game.playTime+I.INPUT_REPEAT_MILLIS}handleInput(t,e){this.handleDefaultKeys();const i=game.inputManager;if(this.substate!=="GAME_OVER"&&i.enter(!0)){game.paused=!game.paused,this.lastMazeScreenKeypressTime=e;return}if(!game.paused)switch(this.substate){case"IN_GAME":game.pacman.handleInput(this.maze);break;case"GAME_OVER":i.enter(!0)&&game.setState(new Ht(game));break}e>=this.lastMazeScreenKeypressTime+I.INPUT_REPEAT_MILLIS&&!game.paused&&this.substate==="IN_GAME"&&i.isKeyDown(v.KEY_Z)&&(i.isKeyDown(v.KEY_X)?(game.loadNextLevel(),this.lastMazeScreenKeypressTime=e):i.isKeyDown(v.KEY_C)&&this.substate!=="DYING"&&(game.startPacmanDying(),this.substate="DYING",this.nextDyingFrameTime=e+I.DYING_FRAME_DELAY_MILLIS,this.lastMazeScreenKeypressTime=e))}update(t){super.update(t),this.handleInput(t,game.playTime);const e=game.playTime;switch(this.substate){case"READY":this.firstTimeThrough&&this.substateStartTime===0&&(this.substateStartTime=e,game.audio.playSound(m.OPENING)),e>=this.substateStartTime+this.readyDelayMillis&&(this.substate="IN_GAME",this.substateStartTime=e,game.resetPlayTime(),this.lastMazeScreenKeypressTime=game.playTime,game.setLoopedSound(m.SIREN),this.firstTimeThrough=!1);break;case"IN_GAME":this.updateInGameImpl(e);break;case"DYING":e>=this.nextDyingFrameTime&&(game.pacman.incDying()?this.nextDyingFrameTime=e+I.DYING_FRAME_DELAY_MILLIS:game.increaseLives(-1)<=0?this.substate="GAME_OVER":(game.resetPlayTime(),this.lastMazeScreenKeypressTime=game.playTime,game.pacman.reset(),game.resetGhosts(),this.substate="READY",this.substateStartTime=0,this._lastSpriteFrameTime=0));break}}updateInGameImpl(t){if(this.nextUpdateTime>0&&t<this.nextUpdateTime)return;this.nextUpdateTime=0,this.updateScoreIndex=-1,this._updateSpriteFrames(),game.updateSpritePositions(this.maze,t);const e=game.checkForCollisions();if(e)switch(e.motionState){case _.BLUE:this.nextUpdateTime=t+F.SCORE_DISPLAY_LENGTH,e.motionState=_.EYES,this.updateScoreIndex=game.ghostEaten(e);break;case _.EYES:case _.EYES_ENTERING_BOX:break;default:game.godMode||(game.startPacmanDying(),this.substate="DYING",this.nextDyingFrameTime=game.playTime+I.DYING_FRAME_DELAY_MILLIS);break}}}const yi=5e4;class F extends Ve{constructor(t){super(t),this.highScore=yi,this.pacman=new _i,this.ghosts=this._createGhostArray(),this.chompSound=0,this._ghostUpdateStrategy=0,this.score=0,this.desktopGame=t.desktopGame?t.desktopGame:this._isRunningInElectron(),this.extraPointsArray=[100,200,300,400,500,700,800,1e3,1600,2e3,3e3,5e3],this._possiblyRegisterDesktopModeListeners()}addFruit(){this.fruit||(this.fruit=new gt,this.fruitScoreIndex=-1,this.fruitScoreEndTime=-1)}checkForCollisions(){for(let t=0;t<this.ghosts.length;t++)if(this.pacman.intersects(this.ghosts[t]))return this.ghosts[t];return this.fruit&&this.fruitScoreIndex===-1&&this.pacman.intersects(this.fruit)&&(this.increaseScore(this.extraPointsArray[this.fruit.pointsIndex]),this.audio.playSound(m.EATING_FRUIT,!1),this.fruitScoreIndex=this.fruit.pointsIndex,this.fruitScoreEndTime=this.playTime+F.SCORE_DISPLAY_LENGTH),null}checkLoopedSound(){if(this.resettingGhostStates)return;let t=!1;for(let e=0;e<this.ghosts.length;e++)if(this.ghosts[e].isEyes()){this.setLoopedSound(m.EYES_RUNNING);return}else this.ghosts[e].isBlue()&&(t=!0);this.setLoopedSound(t?m.CHASING_GHOSTS:m.SIREN)}_createGhostArray(){const t=[];return this.resettingGhostStates=!0,t.push(new Ti(this)),t.push(new Ei(this)),t.push(new vi(this)),t.push(new Ii(this)),this.resettingGhostStates=!1,t}drawBigDot(t,e){const i=this.playTime;if(i<0||i%500>250){const s=this.canvas.getContext("2d"),a=135,r=38;this.assets.get("sprites").drawScaled2(s,a,r,8,8,t,e,8,8)}}drawFruit(t){this.fruit&&this.fruitScoreIndex>-1?(this.paintPointsEarned(t,this.fruitScoreIndex,this.fruit.x,this.fruit.y),this.playTime>=this.fruitScoreEndTime&&(this.fruit=null,this.fruitScoreIndex=-1,this.fruitScoreEndTime=-1)):this.fruit&&this.fruit.paint(t)}drawGhosts(t){this.ghosts.forEach(e=>{e.paint(t)})}drawScores(t){let e=this.score.toString(),i=55-e.length*8;const s=10;this.drawString(i,s,e,t),e=this.highScore.toString(),i=132-e.length*8,this.drawString(i,s,e,t)}drawScoresHeaders(t){this.drawString(16,0,"1UP",t),this.drawString(67,0,"HIGH SCORE",t)}drawSmallDot(t,e){this.canvas.getContext("2d").fillRect(t,e,2,2)}drawSprite(t,e,i,s){const a=this.assets.get("sprites"),r=this.canvas.getContext("2d");a.drawScaled2(r,i,s,16,16,t,e,16,16)}drawString(t,e,i,s=this.canvas.getContext("2d")){const a=i.toString(),r=this.assets.get("font"),o=65,h=48;let l;for(let c=0;c<a.length;c++){const d=a[c],S=a.charCodeAt(c);if(d>="A"&&d<="Z")l=r.colCount+(S-o);else if(d>="0"&&d<="9")l=S-h;else switch(d){case"-":l=10;break;case".":l=11;break;case">":l=12;break;case"@":l=13;break;case"!":l=14;break;default:l=15;break}r.drawByIndex(s,t,e,l),t+=9}}getGhost(t){return this.ghosts[t]}get godMode(){return this._godMode}static get EXTRA_LIFE_SCORE(){return 1e4}get level(){return this._level}get lives(){return this._lives}get PENALTY_BOX_EXIT_X(){return(this.getWidth()-f.SPRITE_SIZE)/2}get PENALTY_BOX_EXIT_Y(){return 12*f.TILE_SIZE-f.TILE_SIZE/2}static get SCORE_DISPLAY_LENGTH(){return 750}ghostEaten(t){switch(this.eatenGhostPointsIndex){case 0:this.eatenGhostPointsIndex=1;break;case 1:this.eatenGhostPointsIndex=3;break;case 3:this.eatenGhostPointsIndex=6;break;default:case 6:this.eatenGhostPointsIndex=8;break}return this.increaseScore(this.extraPointsArray[this.eatenGhostPointsIndex]),this.audio.playSound(m.EATING_GHOST),this.eatenGhostPointsIndex}increaseLives(t){return this._lives+=t}increaseScore(t){this.score+=t,this.score>this.highScore&&(this.highScore=this.score),!this.earnedExtraLife&&this.score>=F.EXTRA_LIFE_SCORE&&(this.audio.playSound(m.EXTRA_LIFE),this.increaseLives(1),this.earnedExtraLife=!0)}isDesktopGame(){return this.desktopGame}_isRunningInElectron(){const t=window;return t&&t.process&&t.process.type}loadNextLevel(){this.setLoopedSound(null),this._level++,this.fruit=null,this.fruitScoreIndex=-1,this.fruitScoreEndTime=-1,this.state.reset()}makeGhostsBlue(){this.eatenGhostPointsIndex=0,this.ghosts.forEach(t=>{t.possiblyTurnBlue()}),this.checkLoopedSound()}paintPointsEarned(t,e,i,s){this.assets.get("points").drawByIndex(t,i,s,e)}playChompSound(){this.audio.playSound(this.chompSound===0?m.CHOMP_1:m.CHOMP_2),this.chompSound=(this.chompSound+1)%2}_possiblyRegisterDesktopModeListeners(){this.isDesktopGame()&&window.addEventListener("resize",()=>{Yt.resize(this.canvas,this.stretchMode)})}resetGhosts(){this.resettingGhostStates=!0;const t=[new k(2,1),new k(2,g.TILE_COUNT_HORIZONTAL-2),new k(g.TILE_COUNT_VERTICAL-2,1),new k(g.TILE_COUNT_VERTICAL-2,g.TILE_COUNT_HORIZONTAL-2)],e=H.randomInt(4);for(let i=0;i<this.ghosts.length;i++)this.ghosts[i].reset(),this.ghosts[i].setCorner(t[(e+i)%4]);this.resettingGhostStates=!1}setLoopedSound(t){t!==this.loopedSoundName&&(this.loopedSoundId!=null&&this.audio.stopSound(this.loopedSoundId),this.loopedSoundName=t,this.loopedSoundId=t!=null?this.audio.playSound(t,!0):null)}set ghostUpdateStrategy(t){this._ghostUpdateStrategy=t}startGame(t){this._lives=3,this.score=0,this._level=0;const i=this.assets.get("levels")[t],s=new I(i);this.setState(s)}startPacmanDying(){this.setLoopedSound(null),this.audio.playSound(m.DIES),this.pacman.startDying(),this.fruit=null,this.fruitScoreIndex=-1,this.fruitScoreEndTime=-1}toggleGodMode(){return this._godMode=!this._godMode,this.setStatusMessage("God mode "+(this._godMode?"enabled":"disabled")),this._godMode}toggleStretchMode(){if(this.isDesktopGame()){switch(this.stretchMode){default:case L.STRETCH_NONE:this.stretchMode=L.STRETCH_FILL;break;case L.STRETCH_FILL:this.stretchMode=L.STRETCH_PROPORTIONAL;break;case L.STRETCH_PROPORTIONAL:this.stretchMode=L.STRETCH_NONE;break}this.setStatusMessage("Stretch mode: "+L[this.stretchMode]),Yt.resize(this.canvas,this.stretchMode)}}updateSpriteFrames(){this.pacman.updateFrame(),this.ghosts.forEach(t=>{t.updateFrame()})}updateSpritePositions(t,e){switch(this._ghostUpdateStrategy){case 0:this.ghosts.forEach(i=>{i.updatePosition(t,e)});break;case 1:break;case 2:this.ghosts[0].updatePosition(t,e);break}this.pacman.updatePosition(t,e)}}const wi=n=>parseInt(n,16),bi=n=>{n.forEach(t=>{for(let e=0;e<t.length;e++)t[e]=t[e].map(wi)})};class Oi extends M{constructor(t){super(t),this.assetsLoaded=!1}update(t){if(this.handleDefaultKeys(),!this.assetsLoaded){this.assetsLoaded=!0;const e=this.game;e.assets.addImage("loading","res/loadingMessage.png"),e.assets.onLoad(()=>{e.assets.addImage("title","res/title.png"),e.assets.addSpriteSheet("font","res/font.png",9,7,0,0),e.assets.addImage("sprites","res/sprite_tiles.png",!0),e.assets.addSpriteSheet("mapTiles","res/map_tiles.png",8,8,0,0),e.assets.addSpriteSheet("points","res/points.png",18,9,0,0),e.assets.addJson("levels","res/levelData.json"),e.assets.addSound(m.CHASING_GHOSTS,"res/sounds/chasing_ghosts.wav"),e.assets.addSound(m.CHOMP_1,"res/sounds/chomp_1.wav"),e.assets.addSound(m.CHOMP_2,"res/sounds/chomp_2.wav"),e.assets.addSound(m.DIES,"res/sounds/dies.wav"),e.assets.addSound(m.EATING_FRUIT,"res/sounds/eating_fruit.wav"),e.assets.addSound(m.EATING_GHOST,"res/sounds/eating_ghost.wav"),e.assets.addSound(m.EXTRA_LIFE,"res/sounds/extra_life.wav"),e.assets.addSound(m.EYES_RUNNING,"res/sounds/eyes_running.wav"),e.assets.addSound(m.INTERMISSION,"res/sounds/intermission.wav"),e.assets.addSound(m.OPENING,"res/sounds/opening.wav"),e.assets.addSound(m.SIREN,"res/sounds/siren.wav"),e.assets.addSound(m.TOKEN,"res/sounds/token.wav"),e.assets.onLoad(()=>{bi(e.assets.get("levels")),H.getRequestParam("skipTitle")!==null?this.game.startGame(0):e.setState(new Ze(this,new Ht))})})}}}const Ai=224,Li=288;window.init=function(n,t){const e=window;e.game=new F({parent:n,width:Ai,height:Li,assetRoot:t,keyRefreshMillis:300,targetFps:60}),e.game.setState(new Oi),e.game.start()};window.init("parent","src/");
